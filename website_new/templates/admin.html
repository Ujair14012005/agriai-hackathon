<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - KrishiConnect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">ðŸŒ± KrishiConnect</a>
  </div>
</nav>

<div class="container mt-4">
  <div class="card p-3 shadow">
    <h4>Weather & Alerts</h4>
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label small">Location</label>
        <input id="location" class="form-control" value="Delhi" />
      </div>
      <div class="col-md-2">
        <label class="form-label small">Language</label>
        <select id="lang" class="form-select"><option>English</option><option>Hindi</option></select>
      </div>
      <div class="col-md-3">
        <label class="form-label small">Farmer phone (E.164)</label>
        <input id="phone" class="form-control" placeholder="+91xxxxxxxxxx" />
      </div>
      <div class="col-md-3">
        <button id="weatherBtn" class="btn btn-primary w-100">Fetch weather</button>
      </div>
    </div>

    <div id="weatherArea" class="mt-3"></div>

    <div class="mt-3 d-flex gap-2">
      <button id="sendWhatsappBtn" class="btn btn-success">Send WhatsApp start message</button>
      <button id="sendSmsBtn" class="btn btn-outline-secondary">Send SMS (Twilio)</button>
    </div>

    <div id="admin_out" class="mt-3"></div>
  </div>
</div>

<script>
document.getElementById('weatherBtn').addEventListener('click', async ()=>{
  const location = document.getElementById('location').value.trim();
  const lang = document.getElementById('lang').value;
  if(!location){ alert('Enter location'); return; }
  document.getElementById('weatherArea').innerText = 'Fetching...';
  try{
    const res = await fetch('{{ url_for("api_fetch_weather") }}', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({location, language: lang})
    });
    const j = await res.json();
    if(res.ok && j.ok){
      document.getElementById('weatherArea').innerHTML = `<div class="card p-3">${j.message.replace(/\n/g,'<br>')}</div>`;
    } else {
      document.getElementById('weatherArea').innerHTML = `<div class="alert alert-warning">Failed: ${j.error||'no data'}</div>`;
    }
  }catch(e){
    document.getElementById('weatherArea').innerHTML = `<div class="alert alert-danger">Request failed</div>`;
    console.error(e);
  }
});

document.getElementById('sendWhatsappBtn').addEventListener('click', async ()=>{
  const phone = document.getElementById('phone').value.trim();
  const weatherHtml = document.getElementById('weatherArea').innerText || '';
  if(!phone){ alert('Enter farmer phone'); return; }
  if(!weatherHtml){ alert('Fetch weather first'); return; }
  try{
    const res = await fetch('{{ url_for("api_send_whatsapp") }}', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone: phone, message: weatherHtml })
    });
    const j = await res.json();
    if(res.ok && j.ok){
      document.getElementById('admin_out').innerHTML = `<div class="alert alert-success">WhatsApp sent â€” ${JSON.stringify(j.info)}</div>`;
    } else {
      document.getElementById('admin_out').innerHTML = `<div class="alert alert-danger">Send failed: ${j.error||j.info}</div>`;
    }
  }catch(e){
    console.error(e);
    document.getElementById('admin_out').innerHTML = '<div class="alert alert-danger">Request failed</div>';
  }
});

document.getElementById('sendSmsBtn').addEventListener('click', async ()=>{
  alert('SMS send not implemented on frontend sample. Use WhatsApp button or extend backend to support SMS.');
});
</script>
</body>
</html>
