<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advisory - KrishiConnect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">ðŸŒ± KrishiConnect</a>
    <div class="ms-auto d-flex gap-2">
      <select id="language" class="form-select form-select-sm" style="width:140px">
        <option>English</option>
        <option>Hindi</option>
      </select>
      <a href="{{ url_for('chatbot_page') }}" class="btn btn-outline-primary btn-sm">Chatbot</a>
      <a href="{{ url_for('programs_page') }}" class="btn btn-outline-secondary btn-sm">Programs</a>
    </div>
  </div>
</nav>

<div class="container" style="margin-top:30px">
  <div class="card p-4 shadow">
    <h4>Ask for advisory</h4>
    <p class="text-muted">Type your question and optionally upload an image. Select language, crop and location for better context.</p>

    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <label class="form-label small">Language</label>
        <select id="lang" class="form-select">
          <option>English</option>
          <option>Hindi</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label small">Crop</label>
        <select id="crop" class="form-select">
          <option>banana</option><option>rice</option><option>coconut</option><option>tapioca</option><option>vegetable</option><option>other</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label small">Location (city or district)</label>
        <input id="location" class="form-control" placeholder="e.g. Delhi" />
      </div>
    </div>

    <div class="mb-3">
      <textarea id="question" class="form-control" rows="4" placeholder="Describe symptoms / ask your question..."></textarea>
    </div>

    <div class="mb-3">
      <input id="image" type="file" accept="image/*" class="form-control"/>
      <div class="form-text">Clear close-up of affected leaf/plant works best.</div>
    </div>

    <div class="d-flex gap-2">
      <button id="askBtn" class="btn btn-success">Get advice</button>
      <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
    </div>

    <div id="answerArea" class="mt-4"></div>
  </div>
</div>

<script>
async function toDataURL(file){
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

function showMsg(html){
  document.getElementById('answerArea').innerHTML = html;
}

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('question').value = '';
  document.getElementById('image').value = '';
  showMsg('');
});

document.getElementById('askBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('question').value.trim();
  const f = document.getElementById('image').files[0];
  const lang = document.getElementById('lang').value || 'English';
  const crop = document.getElementById('crop').value || '';
  const location = document.getElementById('location').value || '';

  if(!q && !f){
    alert('Please type a question or upload an image.');
    return;
  }

  let image_base64 = null;
  if(f){
    try{
      image_base64 = await toDataURL(f);
    }catch(e){
      console.error('Image read failed', e);
    }
  }

  showMsg('<div class="text-muted">Generating answerâ€¦</div>');

  try{
    const payload = { query: q, location: location, crop: crop, language: lang };
    if(image_base64) payload.image_base64 = image_base64;

    const resp = await fetch('{{ url_for("api_get_advice") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const js = await resp.json();
    if(resp.ok && js.ok){
      const safe = js.answer.replace(/\n/g,'<br>');
      showMsg('<div class="card p-3 bg-light">'+safe+'</div>');
    } else {
      const err = js.error || js.answer || 'No answer received';
      showMsg('<div class="alert alert-warning">'+err+'</div>');
    }
  }catch(e){
    console.error(e);
    showMsg('<div class="alert alert-danger">Request failed â€” is the backend running?</div>');
  }
});
</script>
</body>
</html>
