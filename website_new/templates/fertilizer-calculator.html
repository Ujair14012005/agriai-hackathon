<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fertilizer Calculator - KrishiConnect</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
</head>
<body>
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">ðŸŒ± KrishiConnect</a>
  </div>
</nav>

<div class="container mt-4">
  <div class="card p-3 shadow">
    <h4>Fertilizer Calculator</h4>
    <div class="row">
      <div class="col-md-3 mb-3">
        <label>Area unit</label>
        <select id="unit" class="form-select">
          <option>hectare</option>
          <option>acres</option>
          <option>cents</option>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label>Area</label>
        <input id="area" type="number" class="form-control" value="0.1">
      </div>
      <div class="col-md-3 mb-3">
        <label>Crop</label>
        <select id="crop" class="form-select">
          <option>rice</option>
          <option>wheat</option>
          <option>maize</option>
          <option>banana</option>
          <option>vegetable</option>
        </select>
      </div>
      <div class="col-md-3 mb-3 d-flex align-items-end">
        <button id="calc" class="btn btn-success w-100">Calculate</button>
      </div>
    </div>
    <div id="out" class="mt-3"></div>
    <div class="mt-3 text-muted small">
      Note: values are indicative. Use local recommendations for precise dosing.
    </div>
  </div>
</div>

<script>
document.getElementById('calc').addEventListener('click', async ()=>{
  const unit = document.getElementById('unit').value;
  const area = parseFloat(document.getElementById('area').value||0);
  const crop = document.getElementById('crop').value;
  if(!area || area <= 0){ alert('Enter valid area'); return; }

  document.getElementById('out').innerHTML = 'Calculatingâ€¦';

  try{
    const res = await fetch('{{ url_for("api_fertilizer_calc") }}', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ crop: crop, area: area, unit: unit })
    });
    const j = await res.json();
    if(res.ok && j.ok){
      const obj = j.result;
      if(obj.error){
        document.getElementById('out').innerHTML = `<div class="alert alert-warning">${obj.error}</div>`;
      } else {
        document.getElementById('out').innerHTML = `<div class="card p-3">Estimated per ${area} ${unit}: <ul><li>N: ${obj.N} kg</li><li>P2O5: ${obj.P2O5} kg</li><li>K2O: ${obj.K2O} kg</li></ul></div>`;
      }
    } else {
      document.getElementById('out').innerHTML = `<div class="alert alert-danger">Calculation failed</div>`;
    }
  }catch(e){
    console.warn('API failed, fallback to local calc', e);
    const npk={rice:[120,60,40],wheat:[100,50,40],maize:[150,60,40],banana:[250,200,250],vegetable:[120,80,60]};
    let ha = area;
    if(unit==='acres') ha = area*0.404686; 
    if(unit==='cents') ha = area*0.00404686;
    const baseline = npk[crop] || [100,50,40];
    const [bn,bp,bk] = baseline;
    const N = bn*ha, P = bp*ha, K = bk*ha;
    document.getElementById('out').innerHTML = `<div class="card p-3">Estimated per ${area} ${unit} (${ha.toFixed(3)} ha):<ul><li>N: ${N.toFixed(1)} kg</li><li>P: ${P.toFixed(1)} kg</li><li>K: ${K.toFixed(1)} kg</li></ul></div>`;
  }
});
</script>
</body>
</html>
