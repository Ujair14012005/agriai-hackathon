<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Programs - KrishiConnect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
  <style>
    /* small helper style to show selected card */
    .program-item.selected { background: rgba(11,107,58,0.04); }
    .program-item .form-check { flex: 0 0 36px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">ðŸŒ± KrishiConnect</a>
  </div>
</nav>

<div class="container mt-4">
  <div class="card p-3 shadow">
    <div class="row">
      <div class="col-md-4">
        <label class="form-label">Category</label>
        <select id="category" class="form-select mb-3"></select>

        <div id="list" class="list-group" style="max-height:62vh; overflow:auto;"></div>
      </div>

      <div class="col-md-8">
        <div id="content" class="mb-3">Select a category and a program from the left to preview its text.</div>

        <label class="form-label">Question about selected programs</label>
        <textarea id="program_question" class="form-control mb-2" rows="3" placeholder="E.g. How to apply for mechanization subsidy in my state?"></textarea>

        <div class="d-flex gap-2">
          <button id="askProgramsBtn" class="btn btn-success">Ask AI about selected</button>
          <button id="summaryBtn" class="btn btn-outline-secondary">Get short summary</button>
        </div>

        <div id="programs_result" class="mt-4"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* Fetch categories from backend */
async function fetchCategories(){
  try{
    const res = await fetch('/api/list_categories');
    const j = await res.json();
    if(res.ok && j.ok && Array.isArray(j.categories)) return j.categories;
  }catch(e){ console.warn('list_categories failed', e); }
  return ["Loans","Insurance","Mechanization","Policies & Subsidies","Other"];
}

/* Fetch programs for a category */
async function fetchPrograms(lang, category){
  try{
    const res = await fetch('/api/list_programs', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ language: lang, category: category })
    });
    const j = await res.json();
    if(res.ok && j.ok && Array.isArray(j.programs)) return j.programs;
  }catch(e){ console.warn('list_programs failed', e); }
  return [];
}

/* Create safe DOM id */
function safeId(s){ return (s||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }

/* Render left list; clicking item toggles checkbox + preview */
function renderList(programs){
  const list = document.getElementById('list');
  list.innerHTML = '';
  if(programs.length === 0){
    list.innerHTML = '<div class="p-3 text-muted">No program documents found in this category.</div>';
    return;
  }

  programs.forEach((p, idx) => {
    const id = p.id || `prog_${idx}`;
    const short = p.excerpt || '';
    const idSafe = safeId(id);

    // anchor wrapper (acts like list-group-item)
    const a = document.createElement('a');
    a.href = '#';
    a.className = 'list-group-item list-group-item-action d-flex align-items-start program-item';
    a.style.cursor = 'pointer';
    a.innerHTML = `
      <div class="form-check me-3" style="min-width:36px;">
        <input class="form-check-input" type="checkbox" value="${id}" id="chk_${idSafe}">
      </div>
      <div style="flex:1;">
        <div class="fw-bold">${p.title || id}</div>
        <div class="small text-muted">${short}</div>
      </div>
    `;

    // append to list
    list.appendChild(a);

    // references to the checkbox element
    const checkbox = a.querySelector(`#chk_${idSafe}`);
    // safety: if there's no explicit checkbox, create one
    if(!checkbox) return;

    // checkbox click => toggle 'selected' class (do not propagate to anchor)
    checkbox.addEventListener('click', function(evt){
      evt.stopPropagation(); // prevent anchor click
      if(this.checked) a.classList.add('selected'); else a.classList.remove('selected');
    });

    // anchor click => toggle checkbox state AND show preview
    a.addEventListener('click', (e) => {
      e.preventDefault();
      // If click originated from checkbox, do nothing (checkbox handler handled it)
      if(e.target && (e.target.tagName === 'INPUT' || e.target.closest('input'))) {
        return;
      }
      // toggle checkbox
      checkbox.checked = !checkbox.checked;
      if(checkbox.checked) a.classList.add('selected'); else a.classList.remove('selected');

      // show preview
      document.getElementById('content').innerHTML = `
        <h5>${p.title || id}</h5>
        <pre style="white-space:pre-wrap; max-height:60vh; overflow:auto;">${(p.text || '').slice(0, 4000)}${(p.text && p.text.length>4000)?'...':''}</pre>
        <div class="small text-muted">Source: ${p.source || ''}</div>
      `;
    });
  });
}

/* Load a category into list */
async function loadCategory(category){
  const lang = 'English';
  document.getElementById('list').innerHTML = '<div class="p-3 text-muted">Loadingâ€¦</div>';
  const programs = await fetchPrograms(lang, category);
  renderList(programs);
}

/* Ask AI for selected programs */
document.getElementById('askProgramsBtn').addEventListener('click', async ()=> {
  const checks = Array.from(document.querySelectorAll('#list input[type=checkbox]:checked')).map(c => c.value);
  if(checks.length === 0){
    alert('Select one or more program documents');
    return;
  }
  const question = document.getElementById('program_question').value || '';
  const lang = 'English';
  document.getElementById('programs_result').innerHTML = 'Asking AIâ€¦';
  try{
    const res = await fetch('/api/programs_query', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ docs: checks, question: question, language: lang })
    });
    const j = await res.json();
    if(res.ok && j.ok){
      document.getElementById('programs_result').innerHTML = `<div class="card p-3">${j.answer.replace(/\n/g,'<br>')}</div>`;
    } else {
      document.getElementById('programs_result').innerText = j.error || 'No response from server';
    }
  }catch(e){
    console.error(e);
    document.getElementById('programs_result').innerHTML = '<div class="alert alert-danger">Request failed â€” check backend.</div>';
  }
});

/* Summary quick-case */
document.getElementById('summaryBtn').addEventListener('click', ()=> {
  document.getElementById('program_question').value = "Please provide a short actionable summary (3-6 bullets).";
  document.getElementById('askProgramsBtn').click();
});

/* On load, fetch categories and load first category */
window.addEventListener('DOMContentLoaded', async ()=>{
  const cats = await fetchCategories();
  const sel = document.getElementById('category');
  sel.innerHTML = '';
  cats.forEach(c=>{
    const o = document.createElement('option');
    o.value = c;
    o.innerText = c;
    sel.appendChild(o);
  });
  sel.addEventListener('change', ()=> loadCategory(sel.value));
  if(sel.options.length) {
    sel.selectedIndex = 0;
    loadCategory(sel.value);
  }
});
</script>
</body>
</html>
